ADR-005: Implementación de Monitor de Tráfico en Vivo (Live Traffic)
Estado: ⏸️ Pausado (Backend Finalizado / Frontend Pendiente)

Fecha: 22-Dic-2025

Contexto: Diagnóstico de saturación de ancho de banda en tiempo real.

1. Contexto y Problema
Los operadores de soporte necesitan validar en tiempo real si un cliente está consumiendo todo su ancho de banda durante una llamada de reclamo ("Internet lento"). Las herramientas legacy (Oráculo) realizan polling constante o usan RADIUS accounting (aún no implementado en nuestra infraestructura nueva). Necesitábamos una solución ligera, bajo demanda y sin estado (stateless) para Beholder.

2. Decisión Arquitectónica
Se decidió implementar un mecanismo de "Consulta bajo demanda" (On-Demand Snapshot) utilizando la API de Mikrotik, evitando el polling continuo para no saturar la CPU de los routers.

Principios de Diseño Aplicados:
Desacoplamiento Frontend-Red: La API no debe recibir la IP del router desde el cliente (Frontend). La API debe ser capaz de resolver la topología de red internamente.

Verdad Técnica sobre Administrativa: Para localizar al usuario, buscamos en la tabla ppp_secrets (lo que está configurado en el router) en lugar de connections (lo que dice el sistema de gestión). Esto permite diagnosticar clientes "No Vinculados" o con errores administrativos.

Atomicidad: La consulta al router usa el flag once=true para obtener una foto instantánea del tráfico sin dejar procesos de monitoreo colgados.

3. Cambios Implementados (Backend)
app/clients/mikrotik.py:

Nueva función obtener_trafico_en_vivo(ip, user, port).

Implementa conexión segura usando credenciales globales (config).

Retorna rx (bajada) y tx (subida) en bits/segundo.

app/db/sqlite.py:

Nuevo método get_router_for_pppoe(pppoe_user).

Lógica Clave: Realiza un query sobre ppp_secrets + LEFT JOIN nodes. Esto garantiza que si el usuario existe en algún Mikrotik de la red, obtenemos su IP y Puerto, independientemente de su estado en ISPCube.

app/main.py:

Nuevo Endpoint: GET /live/{pppoe_user}.

Orquesta la búsqueda en DB y la llamada al Mikrotik.

Devuelve un JSON estandarizado con valores en Mbps.

4. Estado Actual y Pendientes (To-Do)
El Backend es totalmente funcional y responde correctamente a peticiones HTTP.

Resta para retomar:

Frontend (OutputBox.tsx):

Agregar un botón "Ver Consumo en Vivo" junto al estado del PPPoE.

Implementar la llamada fetch al endpoint /live/{usuario}.

Mostrar un spinner de carga mientras consulta.

Renderizar el resultado (Bajada/Subida) en un componente visual (Badge o Texto).